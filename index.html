<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Descargar imagen de mapa en alta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { color-scheme: light dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display:grid; gap:8px; grid-template-columns: 1fr 120px 120px 180px 120px 140px; align-items:center; }
    input,select,button{ padding:10px; border-radius:10px; border:1px solid #3333; }
    button{ cursor:pointer; border:1px solid #3a87ff; }
    #msg{ grid-column:1 / -1; opacity:.8; }
    #preview{ margin-top:16px; max-width:100%; border:1px solid #0002; border-radius:10px; display:none; }
    @media (max-width: 980px){ .grid{ grid-template-columns: 1fr 1fr } }
    .note{ font-size:12px; opacity:.75; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Descargar imagen de mapa en alta</h1>
    <p class="note">Pega un link de Google Maps que tenga @lat,lng,zoomz. Ejemplo: https://www.google.com/maps/@-34.6037,-58.3816,14z</p>

    <div class="grid">
      <input id="gmapsUrl" type="text" placeholder="Link de Google Maps" />
      <input id="widthPx" type="number" min="256" max="8192" step="1" value="2048" title="Ancho px" />
      <input id="heightPx" type="number" min="256" max="8192" step="1" value="2048" title="Alto px" />
      <select id="styleSel" title="Estilo">
        <option value="satellite">satellite</option>
        <option value="hybrid">hybrid</option>
        <option value="streets-v2" selected>streets-v2</option>
        <option value="basic-v2">basic-v2</option>
        <option value="outdoor-v2">outdoor-v2</option>
        <option value="topo-v2">topo-v2</option>
      </select>
      <select id="densitySel" title="Densidad">
        <option value="@2x" selected>@2x</option>
        <option value="">@1x</option>
      </select>
      <button id="downloadBtn">Descargar PNG</button>
      <div id="msg"></div>
    </div>

    <img id="preview" alt="previsualización del mapa" />
  </div>

<script>
  // Reemplazá por tu key de MapTiler
  const MAPTILER_KEY = XlUzB32whUO2ed7bHx3a;

  const $ = (id) => document.getElementById(id);
  const ui = {
    url: $("gmapsUrl"),
    w: $("widthPx"),
    h: $("heightPx"),
    style: $("styleSel"),
    density: $("densitySel"),
    btn: $("downloadBtn"),
    msg: $("msg"),
    preview: $("preview"),
  };

  function setMsg(t){ ui.msg.textContent = t; }

  // Lee lat, lng, zoom de un link común de Google Maps
  function parseGoogleMapsUrl(url) {
    try {
      const u = new URL(url.trim());
      const at = u.pathname.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*),(\d+\.?\d*)z/);
      if (at) return { lat: +at[1], lng: +at[2], z: Math.round(+at[3]) };
      const ll = u.searchParams.get("ll");
      if (ll) {
        const [lat,lng] = ll.split(",").map(Number);
        const z = parseInt(u.searchParams.get("z") || "15", 10);
        return { lat, lng, z };
      }
      const q = u.searchParams.get("q");
      if (q && /^-?\d+(\.\d+)?,-?\d+(\.\d+)?$/.test(q)) {
        const [lat,lng] = q.split(",").map(Number);
        const z = parseInt(u.searchParams.get("z") || "15", 10);
        return { lat, lng, z };
      }
    } catch(e) {}
    return null;
  }

  async function getStaticPNG({lng, lat, z, width, height, style, density}) {
    width = Math.min(Math.max(256, width|0), 8192);
    height = Math.min(Math.max(256, height|0), 8192);
    z = Math.min(Math.max(1, z|0), 22);
    const d = density === "@2x" ? "@2x" : "";
    const url = `https://api.maptiler.com/maps/${style}/static/${lng},${lat},${z}/${width}x${height}${d}.png?key=${MAPTILER_KEY}`;

    setMsg("Descargando imagen...");
    const res = await fetch(url, { mode: "cors" });
    if (!res.ok) {
      const txt = await res.text().catch(()=> "");
      throw new Error(`HTTP ${res.status}. Revisá la API key, el estilo o las restricciones de dominio. ${txt.slice(0,120)}`);
    }
    const blob = await res.blob();
    return { blob, url };
  }

  function downloadBlob(blob, filename) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 500);
  }

  ui.btn.addEventListener("click", async () => {
    try {
      setMsg("Leyendo link...");
      const p = parseGoogleMapsUrl(ui.url.value);
      if (!p) { setMsg("No pude leer lat, lng, zoom. Copiá un link con @lat,lng,zoomz"); return; }

      const width = parseInt(ui.w.value, 10);
      const height = parseInt(ui.h.value, 10);
      const style = ui.style.value;
      const density = ui.density.value;

      const { blob } = await getStaticPNG({ lng:p.lng, lat:p.lat, z:p.z, width, height, style, density });

      // Previsualización
      const objUrl = URL.createObjectURL(blob);
      ui.preview.src = objUrl;
      ui.preview.style.display = "block";

      // Nombre de archivo
      const fname = `map_${style}_${p.lat.toFixed(5)}_${p.lng.toFixed(5)}_z${p.z}_${width}x${height}${density || ""}.png`;
      downloadBlob(blob, fname);

      setMsg(`Listo. Descargado como ${fname}`);
    } catch (err) {
      console.error(err);
      setMsg(err.message || "Error al descargar");
    }
  });

  // Sugerencia de prueba
  ui.url.value = "https://www.google.com/maps/@-34.6037,-58.3816,14z";
</script>
</body>
</html>
